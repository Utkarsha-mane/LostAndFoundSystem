package lost_and_found_system;

import java.util.*;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeParseException;
import java.time.temporal.ChronoUnit;

// ======================== ITEM CLASSES ========================
class Items {
    String location, description, dateFound;
    boolean isClaimed;

    Items(String location, String description, String dateFound) {
        this.location = location;
        this.description = description;
        this.dateFound = dateFound;
        this.isClaimed = false;
    }

    void display() {
        System.out.println("Location Found: " + location);
        System.out.println("Description: " + description);
        System.out.println("Date Found: " + dateFound);
        System.out.println("Claimed: " + (isClaimed ? "Yes" : "No"));
    }
}

// ---------- Category classes ----------
class Electronics extends Items {
    String name, color, brandModel;

    Electronics(String name, String color, String brandModel, String location, String description, String dateFound) {
        super(location, description, dateFound);
        this.name = name;
        this.color = color;
        this.brandModel = brandModel;
    }

    void display() {
        System.out.println("\n--- Electronic Item ---");
        System.out.println("Name: " + name);
        System.out.println("Color: " + color);
        System.out.println("Brand/Model: " + brandModel);
        super.display();
    }
}

class DailyUse extends Items {
    String name, color;

    DailyUse(String name, String color, String location, String description, String dateFound) {
        super(location, description, dateFound);
        this.name = name;
        this.color = color;
    }

    void display() {
        System.out.println("\n--- Daily Use Item ---");
        System.out.println("Name: " + name);
        System.out.println("Color: " + color);
        super.display();
    }
}

class Stationary extends Items {
    String name, color;

    Stationary(String name, String color, String location, String description, String dateFound) {
        super(location, description, dateFound);
        this.name = name;
        this.color = color;
    }

    void display() {
        System.out.println("\n--- Stationary Item ---");
        System.out.println("Name: " + name);
        System.out.println("Color: " + color);
        super.display();
    }
}

class Accessories extends Items {
    String name, color;

    Accessories(String name, String color, String location, String description, String dateFound) {
        super(location, description, dateFound);
        this.name = name;
        this.color = color;
    }

    void display() {
        System.out.println("\n--- Accessory ---");
        System.out.println("Name: " + name);
        System.out.println("Color: " + color);
        super.display();
    }
}

class Miscellaneous extends Items {
    String name;

    Miscellaneous(String name, String location, String description, String dateFound) {
        super(location, description, dateFound);
        this.name = name;
    }

    void display() {
        System.out.println("\n--- Miscellaneous Item ---");
        System.out.println("Name: " + name);
        super.display();
    }
}

class IDCards extends Items {
    String department, uNumber, year;

    IDCards(String department, String uNumber, String year, String location, String description, String dateFound) {
        super(location, description, dateFound);
        this.department = department;
        this.uNumber = uNumber;
        this.year = year;
    }

    void display() {
        System.out.println("\n--- ID Card ---");
        System.out.println("Department: " + department);
        System.out.println("U-Number: " + uNumber);
        System.out.println("Year: " + year);
        super.display();
    }
}

// ======================== DATABASE CLASS ========================
class Database {
    private HashMap<String, HashMap<String, ArrayList<Items>>> itemList = new HashMap<>();
    private Scanner sc = new Scanner(System.in);

    // Utility input
    private String getInput(String prompt) {
        System.out.print(prompt);
        return sc.nextLine().trim();
    }

    // Utility for date validation (must be within 15‚Äì20 days before today)
    private String validateDate() {
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern("d/M/yyyy");
        LocalDate today = LocalDate.now();

        while (true) {
            String dateInput = getInput("Enter date found (dd/mm/yyyy): ");
            try {
                LocalDate entered = LocalDate.parse(dateInput, formatter);
                long diff = ChronoUnit.DAYS.between(entered, today);

                if (diff < 0) {
                    System.out.println("‚ùå Date cannot be in the future!");
                } 
                else if (diff > 20) {
                    System.out.println("‚ö†Ô∏è Date too old! Enter within last 20 days.");
                } else {
                    return dateInput; // ‚úÖ valid
                }
            } catch (DateTimeParseException e) {
                System.out.println("‚ùå Invalid format! Please enter in dd/mm/yyyy format.");
            }
        }
    }

    // Basic string similarity
    private int similarity(String s1, String s2) {
        if (s1.isEmpty() || s2.isEmpty()) return 0;
        s1 = s1.toLowerCase();
        s2 = s2.toLowerCase();
        int matches = 0;
        int len = Math.min(s1.length(), s2.length());
        for (int i = 0; i < len; i++) {
            if (s1.charAt(i) == s2.charAt(i)) matches++;
        }
        return (int) (((double) matches / Math.max(s1.length(), s2.length())) * 100);
    }

    // ---------- REGISTER FOUND ITEM ----------
    void registerFound() {
        System.out.println("\nSelect the type of item found:");
        System.out.println("1. Electronics\n2. Daily Use\n3. Stationary\n4. Accessories\n5. Miscellaneous\n6. ID Card");
        String choice = getInput("Enter choice: ");

        Items item = null;
        String category = "", subKey = "";

        switch (choice) {
            case "1" -> {
                category = "electronics";
                String eName = getInput("Enter device name: ");
                String eColor = getInput("Enter color: ");
                String brand = getInput("Enter brand/model: ");
                String eLoc = getInput("Enter location found: ");
                String eDesc = getInput("Enter description: ");
                String eDate = validateDate();
                item = new Electronics(eName, eColor, brand, eLoc, eDesc, eDate);
                subKey = eName.toLowerCase();
            }
            case "2" -> {
                category = "dailyuse";
                String dName = getInput("Enter item name: ");
                String dColor = getInput("Enter color: ");
                String dLoc = getInput("Enter location found: ");
                String dDesc = getInput("Enter description: ");
                String dDate = validateDate();
                item = new DailyUse(dName, dColor, dLoc, dDesc, dDate);
                subKey = dName.toLowerCase();
            }
            case "3" -> {
                category = "stationary";
                String sName = getInput("Enter item name: ");
                String sColor = getInput("Enter color: ");
                String sLoc = getInput("Enter location found: ");
                String sDesc = getInput("Enter description: ");
                String sDate = validateDate();
                item = new Stationary(sName, sColor, sLoc, sDesc, sDate);
                subKey = sName.toLowerCase();
            }
            case "4" -> {
                category = "accessories";
                String aName = getInput("Enter item name: ");
                String aColor = getInput("Enter color: ");
                String aLoc = getInput("Enter location found: ");
                String aDesc = getInput("Enter description: ");
                String aDate = validateDate();
                item = new Accessories(aName, aColor, aLoc, aDesc, aDate);
                subKey = aName.toLowerCase();
            }
            case "5" -> {
                category = "miscellaneous";
                String mName = getInput("Enter item name: ");
                String mLoc = getInput("Enter location found: ");
                String mDesc = getInput("Enter description: ");
                String mDate = validateDate();
                item = new Miscellaneous(mName, mLoc, mDesc, mDate);
                subKey = mName.toLowerCase();
            }
            case "6" -> {
                category = "idcards";
                String dept = getInput("Enter department: ");
                String uNo = getInput("Enter U-Number: ");
                String year = getInput("Enter year: ");
                String iLoc = getInput("Enter location found: ");
                String iDesc = getInput("Enter description: ");
                String iDate = validateDate();
                item = new IDCards(dept, uNo, year, iLoc, iDesc, iDate);
                subKey = dept.toLowerCase();
            }
            default -> {
                System.out.println("Invalid choice.");
                return;
            }
        }

        itemList.putIfAbsent(category, new HashMap<>());
        itemList.get(category).putIfAbsent(subKey, new ArrayList<>());
        itemList.get(category).get(subKey).add(item);
        System.out.println("\n‚úÖ Item registered successfully!");
    }

    // ---------- SEARCH LOST ITEM ----------
    void searchLost() {
        System.out.println("\nSelect category to search:");
        System.out.println("1. Electronics\n2. Daily Use\n3. Stationary\n4. Accessories\n5. Miscellaneous\n6. ID Card");
        String choice = getInput("Enter choice: ");

        String category = switch (choice) {
            case "1" -> "electronics";
            case "2" -> "dailyuse";
            case "3" -> "stationary";
            case "4" -> "accessories";
            case "5" -> "miscellaneous";
            case "6" -> "idcards";
            default -> null;
        };

        if (category == null) {
            System.out.println("Invalid category.");
            return;
        }

        if (!itemList.containsKey(category) || itemList.get(category).isEmpty()) {
            System.out.println("\n‚ö†Ô∏è No items found in this category yet.");
            return;
        }

        String nameKey = getInput("Enter name or keyword to search: ").toLowerCase();
        if (!itemList.get(category).containsKey(nameKey)) {
            System.out.println("\n‚ö†Ô∏è No items with that name found.");
            return;
        }

        ArrayList<Items> possibleMatches = itemList.get(category).get(nameKey);
        ArrayList<Items> verified;

        if (category.equals("electronics")) verified = verifyElectronics(possibleMatches);
        else if (category.equals("idcards")) verified = verifyIDCards(possibleMatches);
        else verified = verifyGeneric(possibleMatches);

        if (verified.isEmpty()) return;

        System.out.println("\nPossible matches:");
        for (int i = 0; i < verified.size(); i++) {
            System.out.println("\n[" + (i + 1) + "]");
            verified.get(i).display();
        }

        System.out.println("\n‚úÖ Verification complete.");
    }

    // ---------- VERIFICATION METHODS ----------
    private ArrayList<Items> verifyElectronics(ArrayList<Items> list) {
        ArrayList<Items> verified = new ArrayList<>();
        String color = getInput("Enter color: ").toLowerCase();
        String brand = getInput("Enter brand (if known): ").toLowerCase();
        String loc = getInput("Enter location found: ").toLowerCase();

        for (Items item : list) {
            if (item instanceof Electronics e) {
                int score = 0;
                if (e.color.equalsIgnoreCase(color)) score += 40;
                if (e.brandModel.equalsIgnoreCase(brand)) score += 40;
                if (e.location.equalsIgnoreCase(loc)) score += 20;

                if (score >= 50) {
                    System.out.println("\n‚ö†Ô∏è Closest match found:\n");
                    e.display();
                    System.out.println("üí° Similarity score: " + score + "%");

                    String claim = getInput("Do you want to claim this item? (yes/no): ");
                    if (claim.equalsIgnoreCase("yes")) {
                        e.isClaimed = true;
                        System.out.println("‚úÖ Item claimed successfully!");
                        verified.add(e);
                        return verified;
                    }
                }
            }
        }

        if (verified.isEmpty()) System.out.println("‚ö†Ô∏è No matching electronics found.");
        return verified;
    }

    private ArrayList<Items> verifyGeneric(ArrayList<Items> list) {
        ArrayList<Items> verified = new ArrayList<>();
        String color = getInput("Enter color: ").toLowerCase();
        String loc = getInput("Enter location found: ").toLowerCase();

        for (Items item : list) {
            int colorSim = 0, locSim = similarity(item.location, loc);
            if (item instanceof DailyUse d) colorSim = similarity(d.color, color);
            else if (item instanceof Stationary s) colorSim = similarity(s.color, color);
            else if (item instanceof Accessories a) colorSim = similarity(a.color, color);

            int score = (int) (0.5 * colorSim + 0.5 * locSim);
            if (score >= 70) verified.add(item);
        }

        if (verified.isEmpty()) System.out.println("‚ö†Ô∏è No strong matches found.");
        return verified;
    }

    private ArrayList<Items> verifyIDCards(ArrayList<Items> list) {
        ArrayList<Items> verified = new ArrayList<>();
        String year = getInput("Enter year: ").toLowerCase();
        String uNum = getInput("Enter U-Number: ").toLowerCase();
        String loc = getInput("Enter location found: ").toLowerCase();

        for (Items item : list) {
            if (item instanceof IDCards id) {
                int score = 0;
                if (id.year.equalsIgnoreCase(year)) score += 30;
                if (id.uNumber.equalsIgnoreCase(uNum)) score += 40;
                if (id.location.equalsIgnoreCase(loc)) score += 30;

                if (score >= 50) {
                    System.out.println("\n‚ö†Ô∏è Closest match found:\n");
                    id.display();
                    System.out.println("üí° Similarity score: " + score + "%");

                    String claim = getInput("Do you want to claim this item? (yes/no): ");
                    if (claim.equalsIgnoreCase("yes")) {
                        id.isClaimed = true;
                        System.out.println("‚úÖ Item claimed successfully!");
                        verified.add(id);
                        return verified;
                    }
                }
            }
        }

        if (verified.isEmpty()) System.out.println("‚ö†Ô∏è No matching ID cards found.");
        return verified;
    }
}

// ======================== MAIN CLASS ========================
public class LostAndFoundSystem {
    public static void main(String[] args) {
        Database db = new Database();
        Scanner sc = new Scanner(System.in);

        while (true) {
            System.out.println("\n--- Lost and Found Management System ---");
            System.out.println("1. Register Found Item");
            System.out.println("2. Search Lost Item");
            System.out.println("3. Exit");
            System.out.print("Enter choice: ");
            String choice = sc.nextLine();

            switch (choice) {
                case "1" -> db.registerFound();
                case "2" -> db.searchLost();
                case "3" -> {
                    System.out.println("Exiting... Goodbye!");
                    sc.close();
                    return;
                }
                default -> System.out.println("Invalid choice. Try again.");
            }
        }
    }
}
